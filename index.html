<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo del Potere: Online Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Orbitron', sans-serif;
            background: #000010 url('https://www.transparenttextures.com/patterns/stardust.png');
            color: #E0E0E0;
            overflow-x: hidden;
        }
        .cosmic-narrator { filter: drop-shadow(0 0 15px #00d9ff); }
        .arena {
            background: radial-gradient(circle, rgba(41,0,74,0.8) 0%, rgba(15,0,28,0.7) 60%, rgba(0,0,0,0) 100%);
            box-shadow: 0 0 40px #9f00ff, 0 0 80px #4a007a, inset 0 0 30px #4a007a;
            animation: pulse-arena 5s infinite ease-in-out;
        }
        @keyframes pulse-arena { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .universe-stand { border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); transition: all 0.5s ease; }
        .universe-stand.exploded { transform: scale(0.5) rotate(30deg); opacity: 0; filter: blur(10px); }
        .modal-bg { background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); }
        .btn-primary { 
            background: linear-gradient(45deg, #9f00ff, #00d9ff); 
            font-weight: 900; text-transform: uppercase; letter-spacing: 2px; 
            transition: all 0.3s ease; box-shadow: 0 0 10px #9f00ff;
        }
        .btn-primary:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 0 20px #00d9ff; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .zeno-glow { animation: zeno-flash 1s infinite alternate; }
        @keyframes zeno-flash { from { text-shadow: 0 0 10px #ff00ea; } to { text-shadow: 0 0 30px #ff00ea, 0 0 50px #00d9ff; } }
        
        .selection-box { border: 4px solid #00d9ff; box-shadow: 0 0 30px #00d9ff; transform: scale(1.15); z-index: 50; background: rgba(0, 217, 255, 0.2); }
        .selected-flash { animation: flash-selection 0.5s infinite alternate; border-color: #ff00ea !important; box-shadow: 0 0 40px #ff00ea !important; }
        @keyframes flash-selection { from { opacity: 1; } to { opacity: 0.5; } }

        /* Chat Styles */
        #chat-container { transition: transform 0.3s ease; }
        #chat-container.collapsed { transform: translateY(calc(100% - 40px)); }
        .chat-msg { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #00d9ff; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- LOBBY SCREEN -->
    <div id="lobby-screen" class="fixed inset-0 z-[200] bg-gray-900 flex flex-col items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-2xl border-2 border-cyan-500 shadow-[0_0_50px_rgba(0,217,255,0.3)] max-w-md w-full text-center">
            <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400 mb-8 uppercase italic">Torneo del Potere<br><span class="text-xl text-white not-italic tracking-widest">Online Edition</span></h1>
            
            <div class="mb-6 space-y-4">
                <div class="flex justify-center mb-4">
                    <img id="lobby-avatar-preview" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Goku" class="w-24 h-24 rounded-full border-4 border-purple-500 bg-black">
                </div>
                <input type="text" id="nickname-input" placeholder="Il tuo Nickname" class="w-full bg-gray-700 p-3 rounded text-center font-bold outline-none focus:ring-2 ring-cyan-500" maxlength="12">
                <div class="flex gap-2 justify-center">
                    <button class="text-xs text-gray-400 hover:text-white" onclick="randomizeAvatar()">Cambia Avatar</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button class="btn-primary py-3 rounded-lg" onclick="createRoom()">Crea Stanza</button>
                <div class="flex gap-2">
                    <input type="text" id="room-code-input" placeholder="Codice" class="w-full bg-gray-700 rounded px-2 text-center uppercase font-mono tracking-widest outline-none border border-gray-600 focus:border-cyan-500">
                    <button class="bg-gray-700 hover:bg-gray-600 px-3 rounded border border-gray-600" onclick="joinRoom()">Entra</button>
                </div>
            </div>
        </div>
    </div>

    <!-- UI DI GIOCO -->
    <div id="game-ui" class="hidden w-full h-full">
        
        <!-- Info Stanza -->
        <div class="fixed top-4 left-4 z-50 bg-black/60 backdrop-blur p-2 rounded border border-cyan-500/30 flex items-center gap-3">
            <div class="text-left">
                <p class="text-[10px] text-gray-400 uppercase">Stanza</p>
                <p id="room-code-display" class="font-mono font-bold text-cyan-400 text-xl tracking-widest">----</p>
            </div>
            <div class="h-8 w-px bg-gray-600"></div>
            <div class="text-left">
                <p class="text-[10px] text-gray-400 uppercase">Giocatori</p>
                <p id="player-count-display" class="font-bold text-white">1</p>
            </div>
        </div>

        <!-- PANNELLO CLASSIFICHE (DX) -->
        <div id="leaderboards-panel" class="fixed top-5 right-5 z-50 flex flex-col gap-2 items-end pointer-events-none">
            
            <!-- Classifica Team -->
            <div id="provisional-leaderboard" class="bg-black/80 backdrop-blur-sm p-3 rounded-lg w-48 hidden border border-purple-500/30 pointer-events-auto transition-all">
                <h4 class="text-center text-[10px] font-bold mb-2 text-purple-300 uppercase tracking-widest border-b border-purple-500/20 pb-1">Sopravvivenza</h4>
                <div id="provisional-list" class="space-y-1"></div>
            </div>

            <!-- Classifica Top Killers (NEW) -->
            <div id="killers-leaderboard" class="bg-black/80 backdrop-blur-sm p-3 rounded-lg w-48 hidden border border-red-500/30 pointer-events-auto transition-all mt-2">
                <h4 class="text-center text-[10px] font-bold mb-2 text-red-400 uppercase tracking-widest border-b border-red-500/20 pb-1">Top 6 Killers</h4>
                <div id="killers-list" class="space-y-1"></div>
            </div>

        </div>

        <!-- Narratore -->
        <div id="narrator" class="fixed top-4 left-1/2 -translate-x-1/2 z-40 text-center w-full max-w-lg pointer-events-none">
            <img src="https://placehold.co/150x150/000000/00d9ff?text=GS" alt="Narratore" class="w-16 h-16 mx-auto rounded-full cosmic-narrator mb-1 bg-black border border-cyan-500">
            <p id="narrator-text" class="text-sm md:text-base font-bold text-cyan-300 uppercase px-4 py-1 bg-black/60 rounded-full inline-block backdrop-blur">In attesa dell'Host...</p>
        </div>

        <!-- Area di Gioco -->
        <div id="game-container" class="w-full max-w-7xl mx-auto mt-28 md:mt-32 px-4 pb-24">
            
            <!-- Arena Centrale -->
            <div id="arena" class="arena w-full aspect-video md:aspect-[3/1] max-w-4xl mx-auto flex items-center justify-center rounded-full p-8 mb-8 relative overflow-hidden transition-all duration-1000">
                <div id="challenge-display" class="text-center z-10">
                    <h2 class="text-xl md:text-3xl font-black mb-2 uppercase tracking-tighter text-purple-400">Arena del Vuoto</h2>
                    <p id="arena-status" class="text-sm text-gray-400 mb-4">I guerrieri si stanno preparando.</p>
                    
                    <!-- Solo Host vede questo -->
                    <div id="host-controls" class="hidden">
                        <button id="start-round-btn" class="btn-primary py-2 px-6 text-sm" onclick="startRound()">Inizia Sfida</button>
                    </div>
                    <!-- Client vede questo -->
                    <div id="client-waiting" class="hidden">
                        <p class="animate-pulse text-cyan-500 font-bold uppercase text-xs tracking-widest">In attesa dell'Host...</p>
                    </div>
                </div>
            </div>

            <!-- Spalti -->
            <div id="stands" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Generato via JS -->
            </div>
        </div>

        <!-- CHAT -->
        <div id="chat-container" class="fixed bottom-0 right-4 w-72 md:w-80 h-96 bg-gray-900 border-t-2 border-x-2 border-cyan-500 rounded-t-lg z-50 flex flex-col shadow-2xl">
            <div class="h-10 bg-gray-800 flex items-center justify-between px-3 cursor-pointer hover:bg-gray-700 transition-colors" onclick="toggleChat()">
                <span class="font-bold text-sm text-cyan-400 uppercase tracking-widest">Comms Universo 7</span>
                <span id="chat-toggle-icon">‚ñº</span>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-3 space-y-2 bg-black/50"></div>
            <form id="chat-form" class="h-12 bg-gray-800 flex p-1 gap-1" onsubmit="sendChat(event)">
                <input type="text" id="chat-input" class="flex-1 bg-gray-700 rounded px-2 text-sm outline-none text-white placeholder-gray-500" placeholder="Messaggio...">
                <button type="submit" class="bg-cyan-600 hover:bg-cyan-500 px-3 rounded text-white font-bold">></button>
            </form>
        </div>
    </div>

    <!-- MODALE SETUP (Solo Host) -->
    <div id="setup-modal" class="fixed inset-0 z-[100] modal-bg flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 w-full max-w-5xl h-[90vh] rounded-xl border border-purple-500 flex flex-col p-6 shadow-2xl">
            <h2 class="text-3xl font-black text-center text-purple-400 uppercase mb-2">Configurazione Torneo</h2>
            
            <!-- HEADER CON CODICE E LISTA GIOCATORI -->
            <div class="flex flex-col md:flex-row items-center justify-between bg-black/30 p-4 rounded-lg mb-4 gap-4 border border-gray-700">
                <div class="text-center md:text-left">
                    <p class="text-gray-400 text-xs uppercase mb-1">Codice Stanza</p>
                    <span id="setup-modal-code" class="text-cyan-400 font-mono font-black text-4xl tracking-widest cursor-pointer select-all drop-shadow-[0_0_10px_rgba(0,217,255,0.5)]">----</span>
                </div>
                
                <div class="flex-1 w-full md:w-auto">
                    <p class="text-gray-400 text-xs uppercase mb-1 text-center md:text-right">Lobby (<span id="lobby-count" class="text-white font-bold">1</span>)</p>
                    <div id="lobby-players-list" class="flex flex-wrap justify-center md:justify-end gap-2 max-h-20 overflow-y-auto p-1"></div>
                </div>
            </div>

            <div id="setup-container" class="flex-1 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4 p-2 mb-4 bg-black/20 rounded"></div>
            <div class="flex justify-between mt-auto pt-4 border-t border-gray-700">
                <button class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm font-bold" onclick="addUniverseSetup()">+ Universo</button>
                <button class="btn-primary py-2 px-8 rounded" onclick="finalizeSetup()">Avvia Torneo</button>
            </div>
        </div>
    </div>

    <!-- MODALE ATTESA SETUP (Solo Client) -->
    <div id="waiting-setup-modal" class="fixed inset-0 z-[100] modal-bg flex items-center justify-center hidden">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-t-cyan-500 border-r-purple-500 border-b-yellow-500 border-l-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <h2 class="text-2xl font-black text-white uppercase">L'Host sta configurando...</h2>
            <p class="text-gray-400 mt-2">Preparati, il torneo inizier√† a breve.</p>
        </div>
    </div>

    <!-- MODALE ANIMAZIONE SELEZIONE (SUSPENSE) -->
    <div id="selection-modal" class="fixed inset-0 z-[140] modal-bg flex items-center justify-center hidden p-4">
        <!-- Tasto Velocizza -->
        <button onclick="speedUpAnimation()" class="absolute top-4 left-4 z-[200] text-gray-500 hover:text-white hover:border-white border border-gray-600 px-4 py-2 rounded text-xs uppercase font-bold tracking-widest bg-black/50 backdrop-blur transition-all flex items-center gap-2">
            <span class="text-lg">‚è©</span> Velocizza
        </button>

        <div id="selection-content" class="text-center w-full">
            <h2 id="selection-title" class="text-3xl md:text-5xl font-black mb-8 uppercase text-cyan-400 italic">Estrazione...</h2>
            <div id="universe-selector" class="flex flex-wrap justify-center gap-6 mb-12"></div>
            <div id="character-selector" class="flex flex-wrap justify-center gap-4"></div>
        </div>
    </div>

    <!-- MODALE SFIDA / VOTAZIONE -->
    <div id="challenge-modal" class="fixed inset-0 z-[150] modal-bg flex items-center justify-center hidden p-4">
        <div class="w-full max-w-6xl text-center">
            <div id="event-badge" class="hidden inline-block bg-yellow-500 text-black font-black px-3 py-1 rounded text-xs mb-4 uppercase animate-bounce">Evento Speciale</div>
            <h2 id="challenge-title" class="text-4xl md:text-5xl font-black text-white uppercase italic mb-8 drop-shadow-[0_0_10px_rgba(255,0,0,0.8)]">VOTA IL VINCITORE!</h2>
            
            <div id="challenge-content" class="flex flex-wrap items-center justify-center gap-4 md:gap-8">
                <!-- Sfidanti iniettati via JS -->
            </div>

            <div class="mt-8 bg-black/50 inline-block px-6 py-2 rounded-full border border-gray-600">
                <p class="text-xs uppercase text-gray-400 mb-1">Stato Votazioni</p>
                <div class="flex items-center gap-4">
                    <div class="flex -space-x-2" id="voters-avatars"></div>
                    <span id="vote-count-text" class="font-bold text-cyan-400">0 voti</span>
                </div>
            </div>

            <!-- Controlli Host per chiudere il voto -->
            <div id="host-vote-controls" class="hidden mt-8">
                <button class="btn-primary py-3 px-12 bg-gradient-to-r from-red-600 to-orange-600 shadow-red-500/50" onclick="concludeVoting()">CHIUDI TELEVOTO & ELIMINA</button>
            </div>
             <p id="client-vote-msg" class="hidden mt-8 text-sm text-gray-400 animate-pulse">In attesa della decisione dell'Host...</p>
        </div>
    </div>

    <!-- MODALE VINCITORE -->
    <div id="winner-modal" class="fixed inset-0 z-[160] bg-black flex items-center justify-center hidden p-4">
        <div id="winner-content" class="text-center w-full max-w-[90vw]"></div>
    </div>

    <!-- FIREBASE & GAME LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIGURAZIONE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDN5IegCvW1L3wIfJFQkSAY31F8AbqZFFE",
            authDomain: "torneo-del-potere-preferenze.firebaseapp.com",
            projectId: "torneo-del-potere-preferenze",
            storageBucket: "torneo-del-potere-preferenze.firebasestorage.app",
            messagingSenderId: "1097063532606",
            appId: "1:1097063532606:web:5e015655b628b21e83a96f",
            measurementId: "G-GCZT6DX4T2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // STATO LOCALE
        let currentUser = null;
        let currentRoomId = null;
        let isHost = false;
        let localGameData = { universes: [] };
        let localPlayers = {};
        let localLastChallengeId = null; 
        let currentChallengeId = null;
        let isSpeedUp = false; // Flag per velocizzare animazione
        
        // UTILS
        const generateRoomCode = () => Math.random().toString(36).substring(2, 6).toUpperCase();
        const randomAvatar = () => `https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.random()}`;

        // ESPOSIZIONE FUNZIONI GLOBALI (per onclick nell'HTML)
        window.randomizeAvatar = () => {
            document.getElementById('lobby-avatar-preview').src = randomAvatar();
        };

        window.toggleChat = () => {
            document.getElementById('chat-container').classList.toggle('collapsed');
        };

        window.speedUpAnimation = () => {
            isSpeedUp = true;
        };

        const delay = (ms) => new Promise(r => setTimeout(r, isSpeedUp ? 50 : ms)); // Delay helper che rispetta lo speedup

        // --- AUTHENTICATION ---
        signInAnonymously(auth).catch((error) => {
            console.error("Auth Error", error);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("Logged in as", user.uid);
            }
        });

        // --- ROOM LOGIC ---

        window.createRoom = async () => {
            const nickname = document.getElementById('nickname-input').value.trim() || "Host";
            const avatar = document.getElementById('lobby-avatar-preview').src;
            const roomId = generateRoomCode();

            try {
                // Crea stanza
                await setDoc(doc(db, "rooms", roomId), {
                    hostId: currentUser.uid,
                    status: 'setup', 
                    gameData: null, 
                    currentChallenge: null,
                    createdAt: serverTimestamp()
                });

                // Aggiungi player
                await joinRoomLogic(roomId, nickname, avatar, true);
            } catch (e) {
                console.error(e);
                alert("Errore creazione stanza: " + e.message);
            }
        };

        window.joinRoom = async () => {
            const nickname = document.getElementById('nickname-input').value.trim() || "Spettatore";
            const avatar = document.getElementById('lobby-avatar-preview').src;
            const roomId = document.getElementById('room-code-input').value.trim().toUpperCase();

            if(!roomId) return alert("Inserisci un codice stanza!");

            const roomRef = doc(db, "rooms", roomId);
            const roomSnap = await getDoc(roomRef);

            if (!roomSnap.exists()) return alert("Stanza non trovata!");

            await joinRoomLogic(roomId, nickname, avatar, false);
        };

        async function joinRoomLogic(roomId, nickname, avatar, hostStatus) {
            currentRoomId = roomId;
            isHost = hostStatus;

            // Salva info player
            await setDoc(doc(db, "rooms", roomId, "players", currentUser.uid), {
                nickname,
                avatar,
                isHost,
                joinedAt: serverTimestamp(),
                voteData: null // Usiamo un oggetto { charId, challengeId } per validare i voti
            });

            // UI Switch
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('room-code-display').textContent = roomId;
            
            const setupCodeEl = document.getElementById('setup-modal-code');
            if(setupCodeEl) setupCodeEl.textContent = roomId;

            // Init Listeners
            initGameListeners();
        }

        function initGameListeners() {
            // Ascolta cambiamenti stanza
            onSnapshot(doc(db, "rooms", currentRoomId), (doc) => {
                if(!doc.exists()) return; 
                const data = doc.data();
                handleGameState(data);
            });

            // Ascolta giocatori (per conteggio e lista voti)
            onSnapshot(collection(db, "rooms", currentRoomId, "players"), (snapshot) => {
                const players = [];
                snapshot.forEach(doc => {
                    players.push({id: doc.id, ...doc.data()});
                    localPlayers[doc.id] = doc.data();
                });
                document.getElementById('player-count-display').textContent = players.length;
                updateVoteUI(players); 
                updateLobbyUI(players); 
            });

            // Ascolta Chat
            onSnapshot(collection(db, "rooms", currentRoomId, "chat"), (snapshot) => {
                const msgContainer = document.getElementById('chat-messages');
                msgContainer.innerHTML = '';
                const msgs = [];
                snapshot.forEach(doc => msgs.push(doc.data()));
                msgs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                msgs.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = "chat-msg text-xs mb-1";
                    div.innerHTML = `<span class="font-bold text-cyan-400">${msg.sender}:</span> <span class="text-white">${msg.message}</span>`;
                    msgContainer.appendChild(div);
                });
                msgContainer.scrollTop = msgContainer.scrollHeight;
            });
        }

        // --- GAME STATE MANAGER ---

        async function handleGameState(data) {
            if (data.gameData) {
                localGameData = JSON.parse(data.gameData);
                renderStands();
                updateLeaderboard(); 
                updateKillersLeaderboard(); // Aggiorna top killer
            }

            if (data.status === 'setup') {
                document.getElementById('provisional-leaderboard').classList.add('hidden');
                document.getElementById('killers-leaderboard').classList.add('hidden');
                
                if (isHost) {
                    document.getElementById('setup-modal').classList.remove('hidden');
                    if (document.getElementById('setup-container').children.length === 0) {
                        initHostSetup();
                    }
                } else {
                    document.getElementById('waiting-setup-modal').classList.remove('hidden');
                }
            } else if (data.status === 'playing') {
                document.getElementById('setup-modal').classList.add('hidden');
                document.getElementById('waiting-setup-modal').classList.add('hidden');
                document.getElementById('provisional-leaderboard').classList.remove('hidden');
                document.getElementById('killers-leaderboard').classList.remove('hidden');
                
                if (isHost) {
                    document.getElementById('host-controls').classList.remove('hidden');
                } else {
                    document.getElementById('client-waiting').classList.remove('hidden');
                }

                if (data.currentChallenge) {
                    currentChallengeId = data.currentChallenge.id; // Sync ID corrente
                    
                    // Se √® una sfida nuova, avvia l'animazione
                    if (data.currentChallenge.id !== localLastChallengeId) {
                        localLastChallengeId = data.currentChallenge.id;
                        await playSelectionSequence(data.currentChallenge);
                    } 
                    
                    // Assicura che il modale sia aperto se l'animazione √® finita
                    if (document.getElementById('selection-modal').style.display !== 'flex') {
                        openChallengeModal(data.currentChallenge);
                    }
                } else {
                    currentChallengeId = null;
                    document.getElementById('challenge-modal').classList.add('hidden');
                    document.getElementById('selection-modal').style.display = 'none';
                }
            } else if (data.status === 'ended') {
                showWinnerScreen();
            }

            if (data.narratorText) {
                document.getElementById('narrator-text').textContent = data.narratorText;
            }
        }

        // --- ANIMATION & SUSPENSE LOGIC ---
        
        async function playSelectionSequence(challenge) {
            isSpeedUp = false; // Reset flag velocit√†
            
            const activeUniverses = localGameData.universes.filter(u => u.characters.length > 0);
            if(activeUniverses.length === 0) return;

            const modal = document.getElementById('selection-modal');
            const uniSel = document.getElementById('universe-selector');
            const charSel = document.getElementById('character-selector');
            const title = document.getElementById('selection-title');
            
            // Reset visivo
            document.getElementById('challenge-modal').classList.add('hidden');
            modal.style.display = 'flex';
            
            // Render universi (statico per ora)
            uniSel.innerHTML = activeUniverses.map(u => `<img src="${u.image}" id="uni-sel-${u.id}" class="w-20 h-20 rounded-full border-4 border-transparent object-contain bg-black/20">`).join('');
            
            // ESEGUI ANIMAZIONE PER OGNI PARTECIPANTE
            // Se √® Battle Royale o Tradimento, la logica di visualizzazione cambia leggermente
            // Ma per semplicit√† usiamo un loop sequenziale
            
            const participants = challenge.participants;

            for (let i = 0; i < participants.length; i++) {
                const p = participants[i];
                const pNum = i + 1;
                
                title.textContent = `ESTRAZIONE: COMBATTENTE ${pNum}`;
                charSel.innerHTML = ''; // Pulisci char precedenti (o lasciali se vuoi effetto accumulo)
                
                // Anima Universi
                const uniEls = activeUniverses.map(u => document.getElementById(`uni-sel-${u.id}`));
                await runSelectorAnimation(uniEls, p.universeId);
                
                // Mostra Guerrieri dell'Universo scelto
                const u = localGameData.universes.find(u => u.id === p.universeId);
                charSel.innerHTML = u.characters.map(c => `
                    <div id="char-sel-${c.id}" class="text-center p-2 border-4 border-transparent">
                        <img src="${c.image}" class="w-24 h-24 object-contain bg-black/20 rounded-lg">
                        <p class="text-[10px] mt-1 uppercase font-bold text-white">${c.name}</p>
                    </div>`).join('');
                
                const charEls = u.characters.map(c => document.getElementById(`char-sel-${c.id}`));
                await runSelectorAnimation(charEls, p.id);
                
                // Mostra il guerriero selezionato in grande per un attimo?
                // Per ora semplice pausa
                await delay(800);
            }

            await delay(500);
            
            // Fine animazione
            modal.style.display = 'none';
            openChallengeModal(challenge);
        }

        function runSelectorAnimation(elements, targetId) {
            return new Promise(resolve => {
                let speed = 100; // Pi√π lento per suspense
                let i = 0;
                let cycles = 0;
                let last = null;
                
                function animate() {
                    // Controlla velocit√† dinamica
                    if(isSpeedUp) speed = 20;

                    if (last) last.classList.remove('selection-box');
                    
                    const el = elements[i] || elements[0];
                    if(!el) { resolve(); return; }

                    el.classList.add('selection-box');
                    last = el;
                    
                    i++;
                    if (i >= elements.length) { 
                        i = 0; 
                        cycles++; 
                    }
                    
                    if(!isSpeedUp && cycles > 1) speed += 40; // Rallenta progressivamente solo se non speedUp
                    
                    if (speed > 500 || (isSpeedUp && cycles > 2)) {
                        // Cerca target e ferma
                        const targetEl = elements.find(e => e.id.endsWith(targetId));
                        if(targetEl) {
                            if (last) last.classList.remove('selection-box');
                            targetEl.classList.add('selection-box', 'selected-flash'); // FLASH EFFECT
                            setTimeout(() => {
                                targetEl.classList.remove('selected-flash');
                                resolve();
                            }, isSpeedUp ? 100 : 1000);
                        } else {
                             resolve();
                        }
                        return;
                    }
                    
                    setTimeout(animate, speed);
                }
                animate();
            });
        }

        // --- HOST LOGIC (SETUP) ---
        
        function initHostSetup() {
            addUniverseSetupUI("Universo 7", "https://i.imgur.com/t4tA2p7.png", "#f27c00");
            addUniverseSetupUI("Universo 6", "https://i.imgur.com/9iBq25B.png", "#8cff00");
            addUniverseSetupUI("Universo 11", "https://i.imgur.com/JOFy144.png", "#c4c4c4");
            addUniverseSetupUI("Universo 2", "https://i.imgur.com/y33n4mD.png", "#ff00d4");
        }

        window.addUniverseSetup = () => addUniverseSetupUI(); 
        
        function addUniverseSetupUI(name = `Universo`, img = "", color = "#555555") {
             const id = Date.now() + Math.random();
             const html = `
                <div class="uni-setup-item bg-gray-900 p-3 rounded border border-gray-700" id="setup-${id}">
                    <div class="flex gap-2 mb-2">
                        <input type="text" class="uni-name w-full bg-gray-800 text-white px-2 py-1 rounded" value="${name}">
                        <input type="color" class="uni-color" value="${color}">
                    </div>
                    <input type="text" class="uni-img w-full bg-gray-800 text-gray-400 px-2 py-1 rounded text-xs mb-2" value="${img}" placeholder="URL Immagine">
                    <div class="char-grid grid grid-cols-3 gap-1 mb-2"></div>
                    <button class="text-xs text-cyan-400" onclick="addCharSetupUI('${id}')">+ Guerriero</button>
                    <button class="text-xs text-red-500 float-right" onclick="document.getElementById('setup-${id}').remove()">Rimuovi Uni</button>
                </div>
             `;
             document.getElementById('setup-container').insertAdjacentHTML('beforeend', html);
             for(let i=0; i<3; i++) addCharSetupUI(id);
        }

        window.addCharSetupUI = (uniId) => {
            const container = document.getElementById(`setup-${uniId}`).querySelector('.char-grid');
            const html = `
                <div class="char-item bg-black/30 p-1 rounded text-center">
                    <input type="text" class="char-img w-full bg-transparent text-[8px] border-b border-gray-700 text-gray-500 mb-1" placeholder="URL Img">
                    <input type="text" class="char-name w-full bg-transparent text-[10px] text-white text-center" placeholder="Nome">
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        window.finalizeSetup = async () => {
            if(!isHost) return;
            const universes = [];
            const setupItems = document.querySelectorAll('.uni-setup-item');
            
            setupItems.forEach((el, i) => {
                const u = {
                    id: `uni_${i}`,
                    name: el.querySelector('.uni-name').value,
                    image: el.querySelector('.uni-img').value || "https://placehold.co/100x100/1a1a2e/9f00ff?text=U",
                    bgColor: el.querySelector('.uni-color').value,
                    characters: [],
                    eliminated: [],
                    rank: 0
                };
                
                el.querySelectorAll('.char-item').forEach((cEl, j) => {
                    const cName = cEl.querySelector('.char-name').value || `Guerriero ${j+1}`;
                    const cImg = cEl.querySelector('.char-img').value || "https://placehold.co/80x80/2a2a3e/ffffff?text=?";
                    u.characters.push({
                        id: `char_${i}_${j}`,
                        name: cName,
                        image: cImg,
                        universeId: u.id,
                        universeName: u.name,
                        eliminations: 0,
                        eliminationOrder: -1
                    });
                });
                
                if(u.characters.length > 0) universes.push(u);
            });

            if (universes.length < 2) return alert("Crea almeno 2 universi con guerrieri!");

            await updateDoc(doc(db, "rooms", currentRoomId), {
                gameData: JSON.stringify({ universes }), 
                status: 'playing',
                narratorText: "Il Torneo del Potere ha inizio!"
            });
        };

        // --- GAMEPLAY LOGIC ---

        // Solo HOST chiama questo
        window.startRound = async () => {
            const activeUniverses = localGameData.universes.filter(u => u.characters.length > 0);
            const totalChars = activeUniverses.reduce((acc, u) => acc + u.characters.length, 0);

            if (activeUniverses.length < 1 || totalChars < 2) {
                // Fine torneo se c'√® solo 1 universo (se > 1 char in quell'uni, potremmo fare tradimento finale, ma semplifichiamo)
                if(activeUniverses.length === 1 && activeUniverses[0].characters.length === 1) {
                     await updateDoc(doc(db, "rooms", currentRoomId), { status: 'ended' });
                     return;
                }
                // Se solo 1 universo ma pi√π char, forza Tradimento
            }

            // DECISIONE TIPO EVENTO
            const rand = Math.random();
            let type = 'normal';
            let participants = [];
            
            // Possibilit√† Eventi
            const canDoBetrayal = activeUniverses.some(u => u.characters.length >= 2);
            const canDoRoyale = totalChars >= 3;

            if (canDoRoyale && rand > 0.85) {
                type = 'royale';
            } else if (canDoBetrayal && rand > 0.65) {
                type = 'betrayal';
            } else {
                type = 'normal';
            }

            // Costruzione Partecipanti
            if (type === 'normal') {
                // Necessita 2 universi diversi
                if (activeUniverses.length < 2) {
                     // Fallback a betrayal se possibile, altrimenti royale, altrimenti endgame
                     if(canDoBetrayal) type = 'betrayal';
                     else return await updateDoc(doc(db, "rooms", currentRoomId), { status: 'ended' });
                } else {
                    const u1 = activeUniverses[Math.floor(Math.random() * activeUniverses.length)];
                    const c1 = u1.characters[Math.floor(Math.random() * u1.characters.length)];
                    
                    const otherUniverses = activeUniverses.filter(u => u.id !== u1.id);
                    const u2 = otherUniverses[Math.floor(Math.random() * otherUniverses.length)];
                    const c2 = u2.characters[Math.floor(Math.random() * u2.characters.length)];
                    participants = [c1, c2];
                }
            }
            
            if (type === 'betrayal') {
                // Scegli universo con >= 2 char
                const candidates = activeUniverses.filter(u => u.characters.length >= 2);
                if (candidates.length === 0) {
                     // Fallback
                     return startRound(); // Riprova (ricorsivo semplice)
                }
                const u = candidates[Math.floor(Math.random() * candidates.length)];
                // Shuffle chars
                const shuffled = [...u.characters].sort(() => 0.5 - Math.random());
                participants = [shuffled[0], shuffled[1]];
            }

            if (type === 'royale') {
                // Prendi 3 o 4 char random da chiunque
                let pool = [];
                activeUniverses.forEach(u => pool.push(...u.characters));
                // Shuffle
                pool.sort(() => 0.5 - Math.random());
                // Decide 3 or 4
                const count = (pool.length >= 4 && Math.random() > 0.5) ? 4 : 3;
                participants = pool.slice(0, count);
            }

            const challengeId = Date.now().toString();
            
            // Testo narratore
            let narratorText = "";
            if(type === 'normal') narratorText = `Scontro: ${participants[0].name} VS ${participants[1].name}`;
            if(type === 'betrayal') narratorText = `TRADIMENTO! ${participants[0].name} deve affrontare ${participants[1].name}!`;
            if(type === 'royale') narratorText = `BATTLE ROYALE! ${participants.length} Guerrieri nell'arena!`;

            await updateDoc(doc(db, "rooms", currentRoomId), {
                currentChallenge: {
                    id: challengeId,
                    participants: participants, // New generic array
                    c1: participants[0], // Keep for legacy compat in other funcs if needed
                    c2: participants[1], 
                    type: type,
                    startTime: serverTimestamp()
                },
                narratorText: narratorText
            });
        };

        function openChallengeModal(challengeData) {
            const modal = document.getElementById('challenge-modal');
            const container = document.getElementById('challenge-content');
            const badge = document.getElementById('event-badge');
            
            // RESET VOTE UI FORZATO
            document.getElementById('voters-avatars').innerHTML = '';
            document.getElementById('vote-count-text').textContent = '0 voti';

            // Configurazione Badge Evento
            badge.classList.remove('hidden');
            if (challengeData.type === 'normal') {
                badge.classList.add('hidden');
            } else if (challengeData.type === 'betrayal') {
                badge.textContent = "‚ö†Ô∏è TRADIMENTO ‚ö†Ô∏è";
                badge.className = "inline-block bg-red-600 text-white font-black px-3 py-1 rounded text-xs mb-4 uppercase animate-pulse border border-red-400";
            } else if (challengeData.type === 'royale') {
                badge.textContent = "üî• BATTLE ROYALE üî•";
                badge.className = "inline-block bg-yellow-500 text-black font-black px-3 py-1 rounded text-xs mb-4 uppercase animate-bounce border border-yellow-300";
            }

            // Rendering Sfidanti Dinamico
            const ps = challengeData.participants || [challengeData.c1, challengeData.c2];
            
            let html = '';
            ps.forEach((p, index) => {
                // Colore diverso per ogni card in Royale
                const colors = ['blue', 'red', 'green', 'purple'];
                const color = colors[index % colors.length];
                
                html += renderChallengerCard(p, color);
                
                // Aggiungi VS se non √® l'ultimo
                if (index < ps.length - 1) {
                     html += `<div class="text-2xl md:text-4xl font-black text-gray-500 italic self-center">VS</div>`;
                }
            });
            container.innerHTML = html;

            document.getElementById('challenge-title').textContent = 
                challengeData.type === 'royale' ? "CHI SOPRAVVIVE?" : "CHI DEVE VINCERE?";
            
            modal.classList.remove('hidden');

            if(isHost) {
                document.getElementById('host-vote-controls').classList.remove('hidden');
                document.getElementById('client-vote-msg').classList.add('hidden');
            } else {
                document.getElementById('host-vote-controls').classList.add('hidden');
                document.getElementById('client-vote-msg').classList.remove('hidden');
            }
            
            // Aggiorna subito lo stato voti
            updateVoteUI(Object.values(localPlayers));
        }

        function renderChallengerCard(char, colorClass) {
            const borderColors = {
                'blue': 'border-cyan-500', 'red': 'border-red-500', 
                'green': 'border-green-500', 'purple': 'border-purple-500'
            };
            const shadowColors = {
                'blue': 'shadow-cyan-500/50', 'red': 'shadow-red-500/50', 
                'green': 'shadow-green-500/50', 'purple': 'shadow-purple-500/50'
            };
            
            const bc = borderColors[colorClass] || 'border-gray-500';
            const sc = shadowColors[colorClass] || 'shadow-gray-500/50';
            
            return `
                <div class="text-center group flex-1 min-w-[140px]">
                    <div class="w-32 h-32 md:w-48 md:h-48 mx-auto rounded-xl border-4 ${bc} ${sc} bg-black/40 flex items-center justify-center overflow-hidden mb-2 shadow-lg transition-transform hover:scale-105">
                        <img src="${char.image}" class="max-w-full max-h-full object-contain">
                    </div>
                    <p class="text-lg md:text-xl font-black text-white truncate max-w-[150px] mx-auto">${char.name}</p>
                    <p class="text-gray-400 uppercase text-[10px] mb-2">${char.universeName}</p>
                    <button class="btn-primary py-1 px-4 w-full text-xs" onclick="voteFor('${char.id}')">VOTA</button>
                </div>
            `;
        }

        window.voteFor = async (charId) => {
            if (!currentChallengeId) return alert("Nessuna sfida attiva!");

            await updateDoc(doc(db, "rooms", currentRoomId, "players", currentUser.uid), {
                voteData: {
                    charId: charId,
                    challengeId: currentChallengeId
                }
            });
            
            const btns = document.querySelectorAll('#challenge-content button');
            btns.forEach(b => {
                b.textContent = "VOTO REGISTRATO";
                b.disabled = true;
                b.classList.add('opacity-50');
            });
        };

        function updateVoteUI(players) {
            const avatarContainer = document.getElementById('voters-avatars');
            if(!avatarContainer) return;
            
            avatarContainer.innerHTML = '';
            let voteCount = 0;

            const playerArray = Array.isArray(players) ? players : Object.values(players);

            const validVoters = playerArray.filter(p => 
                p.voteData && 
                p.voteData.challengeId === currentChallengeId
            ); 
            
            validVoters.forEach(p => {
                const img = document.createElement('img');
                img.src = p.avatar;
                img.className = "w-8 h-8 rounded-full border-2 border-white bg-black";
                img.title = p.nickname;
                avatarContainer.appendChild(img);
                voteCount++;
            });
            document.getElementById('vote-count-text').textContent = `${voteCount} voti`;
        }

        function updateLobbyUI(players) {
            const list = document.getElementById('lobby-players-list');
            const count = document.getElementById('lobby-count');
            if(!list || !count) return;

            count.textContent = players.length;
            
            const playerArray = Array.isArray(players) ? players : Object.values(players);
            playerArray.sort((a,b) => (b.isHost ? 1 : 0) - (a.isHost ? 1 : 0));

            list.innerHTML = playerArray.map(p => `
                <div class="flex items-center gap-2 bg-gray-700/50 px-3 py-1.5 rounded-full border border-gray-600 animate-[fadeIn_0.3s_ease]">
                    <img src="${p.avatar}" class="w-6 h-6 rounded-full bg-black border border-gray-500">
                    <span class="text-xs font-bold text-gray-200 max-w-[100px] truncate">${p.nickname}</span>
                    ${p.isHost ? '<span class="text-[8px] bg-purple-500 text-white px-1.5 py-0.5 rounded font-bold tracking-wider">HOST</span>' : ''}
                </div>
            `).join('');
        }

        window.concludeVoting = async () => {
            if(!isHost) return;
            
            const roomSnap = await getDoc(doc(db, "rooms", currentRoomId));
            const challenge = roomSnap.data().currentChallenge;
            if(!challenge) return;

            // 1. Conta voti per ogni partecipante
            const participants = challenge.participants || [challenge.c1, challenge.c2];
            let voteMap = {};
            participants.forEach(p => voteMap[p.id] = 0);

            Object.values(localPlayers).forEach(p => {
                if(p.voteData && p.voteData.challengeId === challenge.id) {
                    if(voteMap[p.voteData.charId] !== undefined) {
                        voteMap[p.voteData.charId]++;
                    }
                }
            });

            // 2. Trova Vincitore (Max Votes)
            let winnerId = null;
            let maxVotes = -1;
            
            // Gestione pareggi randomizzata
            const shuffledPart = [...participants].sort(() => 0.5 - Math.random());
            shuffledPart.forEach(p => {
                const v = voteMap[p.id];
                if (v > maxVotes) {
                    maxVotes = v;
                    winnerId = p.id;
                }
            });

            const winner = participants.find(p => p.id === winnerId);
            const losers = participants.filter(p => p.id !== winnerId);

            // 3. Processa Eliminazioni
            const updatedUniverses = [...localGameData.universes];
            let eliminationText = "";

            losers.forEach(loser => {
                const loserUni = updatedUniverses.find(u => u.id === loser.universeId);
                const loserCharIndex = loserUni.characters.findIndex(c => c.id === loser.id);
                if(loserCharIndex > -1) {
                    const [eliminatedChar] = loserUni.characters.splice(loserCharIndex, 1);
                    eliminatedChar.eliminatedAt = Date.now(); // Aggiunto timestamp per classifica
                    loserUni.eliminated.push(eliminatedChar);

                    // Calc Rank
                    if (loserUni.characters.length === 0) {
                         const activeCount = updatedUniverses.filter(u => u.characters.length > 0).length;
                         loserUni.rank = activeCount + 1; 
                    }
                }
            });

            // 4. Assegna Kills
            const winnerUni = updatedUniverses.find(u => u.id === winner.universeId);
            const winnerChar = winnerUni.characters.find(c => c.id === winner.id);
            if(winnerChar) {
                // In Battle Royale, il vincitore prende le kill di TUTTI gli eliminati
                winnerChar.eliminations = (winnerChar.eliminations || 0) + losers.length;
            }

            // Testo Finale
            if (challenge.type === 'royale') {
                eliminationText = `${winner.name} sopravvive al caos! ${losers.length} eliminati!`;
            } else if (challenge.type === 'betrayal') {
                eliminationText = `${winner.name} sacrifica il compagno e avanza!`;
            } else {
                eliminationText = `${winner.name} vince lo scontro!`;
            }

            await updateDoc(doc(db, "rooms", currentRoomId), {
                gameData: JSON.stringify({ universes: updatedUniverses }),
                currentChallenge: null,
                narratorText: eliminationText
            });
        };

        function updateLeaderboard() {
            const list = document.getElementById('provisional-list');
            if(!list) return;
            
            const sorted = [...localGameData.universes].sort((a, b) => b.characters.length - a.characters.length);
            
            list.innerHTML = sorted.map(u => `
                <div class="flex items-center justify-between text-[10px] ${u.characters.length===0?'opacity-30':''}">
                    <div class="flex items-center gap-1 truncate">
                        <img src="${u.image}" class="w-4 h-4 rounded-full object-contain bg-black/40">
                        <span class="truncate font-bold text-gray-300">${u.name}</span>
                    </div>
                    <span class="font-black text-cyan-400">${u.characters.length}</span>
                </div>`
            ).join('');
        }

        // --- NEW: TOP KILLERS LEADERBOARD ---
        function updateKillersLeaderboard() {
            const list = document.getElementById('killers-list');
            if(!list) return;

            let allChars = [];
            localGameData.universes.forEach(u => {
                // Guerrieri attivi
                u.characters.forEach(c => allChars.push({...c, status: 'active', color: u.bgColor}));
                // Guerrieri eliminati (che mantengono il conto kill)
                if(u.eliminated) {
                    u.eliminated.forEach(c => allChars.push({...c, status: 'eliminated', color: u.bgColor}));
                }
            });

            // Filtra chi ha almeno 1 kill e ordina decrescente
            const killers = allChars.filter(c => (c.eliminations || 0) > 0)
                                    .sort((a,b) => b.eliminations - a.eliminations)
                                    .slice(0, 6); // Top 6

            if (killers.length === 0) {
                 list.innerHTML = '<p class="text-[10px] text-gray-500 text-center italic">Nessuna eliminazione</p>';
                 return;
            }

            list.innerHTML = killers.map(c => `
                <div class="flex items-center justify-between text-[10px] ${c.status === 'eliminated' ? 'opacity-50 grayscale' : ''}">
                    <div class="flex items-center gap-2 truncate max-w-[80%]">
                        <img src="${c.image}" class="w-5 h-5 rounded-full border border-gray-500 bg-black object-contain">
                        <span class="truncate font-bold text-gray-200">${c.name}</span>
                    </div>
                    <span class="font-black text-red-500 text-xs flex items-center gap-1">
                        ${c.eliminations} <span class="text-[8px] text-gray-500">KO</span>
                    </span>
                </div>
            `).join('');
        }

        function renderStands() {
            const container = document.getElementById('stands');
            container.innerHTML = localGameData.universes.map(u => {
                const backgroundStyle = `background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), ${u.bgColor};`;
                const isEliminated = u.characters.length === 0;
                
                return `
                <div class="universe-stand p-4 ${isEliminated ? 'exploded border-red-900' : ''}" style="${backgroundStyle}">
                    <div class="flex items-center gap-2 mb-3">
                        <img src="${u.image}" class="w-10 h-10 rounded-full border border-white/20 object-contain bg-black/40">
                        <h3 class="text-sm font-black text-white uppercase truncate">${u.name}</h3>
                    </div>
                    <p class="text-[10px] text-gray-400 mb-2 uppercase">Guerrieri: <span class="font-bold text-white">${u.characters.length}</span></p>
                    <div class="grid grid-cols-4 gap-1">
                         ${u.eliminated.map(c => `
                            <div class="aspect-square bg-black/30 rounded border border-red-500/20 overflow-hidden relative group">
                                <img src="${c.image}" class="w-full h-full object-contain grayscale opacity-50">
                                ${(c.eliminations||0) > 0 ? `<div class="absolute top-0 right-0 bg-red-600 text-white text-[8px] font-bold px-1 rounded-bl shadow">‚òÖ${c.eliminations}</div>` : ''}
                            </div>
                         `).join('')}
                    </div>
                </div>`;
            }).join('');
        }

        function showWinnerScreen() {
            const modal = document.getElementById('winner-modal');
            const winner = localGameData.universes.find(u => u.characters.length > 0);
            
            const allUniverses = [...localGameData.universes].map(u => {
                if (u.characters.length > 0) return { ...u, rank: 1 };
                return u;
            });
            
            allUniverses.sort((a, b) => (a.rank || 99) - (b.rank || 99));

            // --- 1. CLASSIFICA KILLER (Mantenuta) ---
            let allChars = [];
            localGameData.universes.forEach(u => {
                if (u.characters) u.characters.forEach(c => allChars.push({...c, uniName: u.name, uniColor: u.bgColor}));
                if (u.eliminated) u.eliminated.forEach(c => allChars.push({...c, uniName: u.name, uniColor: u.bgColor}));
            });
            allChars.sort((a, b) => (b.eliminations || 0) - (a.eliminations || 0));
            const topKillers = allChars.slice(0, 10);

            // --- 2. CLASSIFICA GENERALE (Sopravvivenza) ---
            let survivalRanking = [];
            
            // A. Sopravvissuti (1¬∞ Posto Pari Merito)
            localGameData.universes.forEach(u => {
                u.characters.forEach(c => {
                    survivalRanking.push({...c, status: 'survivor', uniName: u.name, uniColor: u.bgColor, rankText: 'Vincitore'});
                });
            });

            // B. Eliminati (Ordinati per timestamp descrescente = chi √® uscito per ultimo)
            let eliminatedList = [];
            localGameData.universes.forEach(u => {
                if(u.eliminated) {
                    u.eliminated.forEach(c => {
                        eliminatedList.push({...c, status: 'eliminated', uniName: u.name, uniColor: u.bgColor});
                    });
                }
            });
            eliminatedList.sort((a,b) => (b.eliminatedAt || 0) - (a.eliminatedAt || 0));

            // Assegna posizioni (es. 2¬∞, 3¬∞...)
            let currentPos = survivalRanking.length + 1; 
            eliminatedList.forEach((c, index) => {
                c.rankText = `${currentPos + index}¬∞`;
                survivalRanking.push(c);
            });

            // Prendi i primi 15 per visualizzazione
            const topSurvival = survivalRanking.slice(0, 15);


            document.getElementById('winner-content').innerHTML = `
                <h1 class="text-4xl md:text-6xl font-black text-yellow-400 zeno-glow uppercase mb-6">TORNEO CONCLUSO</h1>
                <h2 class="text-xl md:text-3xl text-white mb-6">VINCITORE: ${winner ? winner.name : 'NESSUNO'}</h2>
                
                <div class="max-w-[95vw] mx-auto bg-gray-900/80 rounded-xl p-4 md:p-6 border border-gray-700 max-h-[70vh] overflow-y-auto custom-scroll grid grid-cols-1 md:grid-cols-3 gap-6 text-left">
                    
                    <!-- COLONNA 1: CLASSIFICA UNIVERSI -->
                    <div class="bg-black/20 p-2 rounded">
                        <h3 class="text-lg text-cyan-400 font-bold mb-3 uppercase tracking-widest border-b border-gray-700 pb-1 text-center">Universi</h3>
                        <div class="space-y-1">
                            ${allUniverses.map(u => `
                                <div class="flex items-center justify-between bg-black/40 p-2 rounded border ${u.rank === 1 ? 'border-yellow-500/50 bg-yellow-500/10' : 'border-gray-700'}">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xl font-black ${u.rank === 1 ? 'text-yellow-400' : 'text-gray-500'} w-6 text-center">${u.rank || '-'}</span>
                                        <img src="${u.image}" class="w-6 h-6 rounded-full bg-black object-contain border border-gray-600">
                                        <span class="font-bold text-white text-xs">${u.name}</span>
                                    </div>
                                    ${u.rank === 1 ? '<span class="text-[8px] font-bold text-yellow-400 uppercase bg-yellow-400/20 px-1 py-0.5 rounded">Win</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- COLONNA 2: CLASSIFICA GENERALE (SURVIVAL) -->
                    <div class="bg-black/20 p-2 rounded border-x border-gray-700/50">
                        <h3 class="text-lg text-green-400 font-bold mb-3 uppercase tracking-widest border-b border-gray-700 pb-1 text-center">Classifica Generale</h3>
                        <div class="space-y-1">
                            ${topSurvival.map((c) => `
                                <div class="flex items-center justify-between bg-black/40 p-2 rounded border ${c.status === 'survivor' ? 'border-yellow-500/30' : 'border-gray-800'} hover:bg-white/5 transition-colors">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-mono text-gray-400 w-8 text-right mr-1">${c.rankText}</span>
                                        <img src="${c.image}" class="w-6 h-6 rounded-full bg-black object-contain border border-gray-600">
                                        <div class="flex flex-col">
                                            <span class="font-bold text-white text-xs truncate max-w-[100px]">${c.name}</span>
                                            <span class="text-[8px] text-gray-500 uppercase">${c.uniName}</span>
                                        </div>
                                    </div>
                                    ${c.status === 'survivor' ? 'üëë' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- COLONNA 3: MVP / KILLERS -->
                    <div class="bg-black/20 p-2 rounded">
                        <h3 class="text-lg text-red-400 font-bold mb-3 uppercase tracking-widest border-b border-gray-700 pb-1 text-center">Top Killers</h3>
                        <div class="space-y-1">
                            ${topKillers.map((c, i) => `
                                <div class="flex items-center justify-between bg-black/40 p-2 rounded border border-gray-800 hover:border-red-500/30 transition-colors">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg font-bold text-gray-600 w-6 text-center">${i+1}</span>
                                        <img src="${c.image}" class="w-6 h-6 rounded-full bg-black object-contain border border-gray-600">
                                        <div class="flex flex-col">
                                            <span class="font-bold text-white text-xs truncate max-w-[100px]">${c.name}</span>
                                            <span class="text-[8px] text-gray-500 uppercase">${c.uniName}</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-1 bg-red-900/20 px-2 py-0.5 rounded">
                                        <span class="font-black text-red-400 text-sm">${c.eliminations || 0}</span>
                                        <span class="text-[8px] text-gray-500">KO</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                </div>

                <button class="btn-primary mt-6 py-3 px-8" onclick="location.reload()">Torna alla Lobby</button>
            `;
            modal.classList.remove('hidden');
        }

        window.sendChat = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            const myData = localPlayers[currentUser.uid];
            const senderName = myData ? myData.nickname : "Anonimo";

            await setDoc(doc(collection(db, "rooms", currentRoomId, "chat")), {
                sender: senderName,
                message: text,
                timestamp: serverTimestamp()
            });
            
            input.value = '';
        };

    </script>
</body>
</html>
```eof